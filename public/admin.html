<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
  <link rel="shortcut icon" href="icons/favicon.ico">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="theme.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <title>VEPA AutoCare Admin</title>
  <style>
    :root {
      --bg-light: #fff;
      --bg-dark: #000;
      --primary: #5a31f4;
      --text-dark: #111;
      --text-light: #555;
      --accent: #474747;
      --radius: 6px;
      --gap: 1rem;
      --btn-height: 40px;
      --input-height: 40px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
    }
    header {
      position: sticky; top: 0; width: 100%; z-index: 10;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
      padding: var(--gap) calc(2*var(--gap));
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .logo { font-size: 1.5rem; font-weight: bold; color: var(--text-dark); }
    nav ul { list-style: none; display: flex; gap: var(--gap); flex-wrap: wrap; }
    nav a {
      font-size: 0.9rem; text-transform: uppercase; color: var(--text-light);
      transition: color 0.2s;
    }
    nav a:hover { color: var(--primary); }

    main { flex: 1; padding: calc(6*var(--gap)) var(--gap); }

    /* Admin Controls Section (Add New Car + Import) */
    .admin-controls {
      display: flex; flex-wrap: wrap; gap: var(--gap);
      margin-bottom: calc(2*var(--gap));
      justify-content: space-between;
      align-items: flex-end;
    }
    .admin-controls input,
    .admin-controls select {
      padding: 0 0.75rem; font-size: 0.95rem; height: var(--input-height);
      border: 1px solid #ccc; border-radius: var(--radius); flex: 1 1 200px;
    }
    .admin-controls button {
      background: var(--primary); color: var(--bg-light);
      border: none; cursor: pointer; height: var(--btn-height);
      padding: 0 1rem; font-size: 0.95rem; border-radius: var(--radius);
      transition: background 0.2s;
    }
    .admin-controls button:hover { background: #7b3ea6; }
    .admin-controls .import-btn {
      background: var(--accent); margin-left: auto;
    }
    .admin-controls .import-btn:hover {
      background: #333333;
    }
    .admin-controls .hidden-file-input {
      display: none;
    }

    /* Filter / Search Section */
    .admin-filter-sort {
      display: flex; flex-wrap: wrap; gap: var(--gap);
      margin-bottom: calc(2*var(--gap)); justify-content: space-between;
      background: rgba(0,0,0,0.05); padding: var(--gap); border-radius: var(--radius);
    }
    .admin-filter-sort input,
    .admin-filter-sort select {
      flex: 1 1 200px; padding: 0 0.75rem;
      font-size: 0.95rem; height: var(--input-height);
      border: 1px solid #ccc; border-radius: var(--radius);
    }
    .admin-filter-sort button {
      background: var(--primary); color: var(--bg-light);
      border: none; cursor: pointer; padding: 0 1rem;
      font-size: 0.95rem; height: var(--btn-height); border-radius: var(--radius);
      transition: background 0.2s;
    }
    .admin-filter-sort button:hover { background: #7b3ea6; }

    /* Table Wrapper */
    .table-wrapper { overflow-x: auto; }
    table {
      width: 100%; border-collapse: collapse; min-width: 800px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: var(--gap); text-align: center;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    th {
      background: var(--primary); color: var(--bg-light); text-transform: uppercase;
      font-size: 0.9rem;
    }
    td img.thumbnail {
      width: 80px; height: 60px; object-fit: cover; border-radius: var(--radius);
      cursor: pointer; transition: transform 0.2s;
    }
    td img.thumbnail:hover {
      transform: scale(1.1);
    }
    .action-btn {
      padding: 0.35rem 0.75rem; border: none; border-radius: var(--radius);
      cursor: pointer; color: #fff; font-size: 0.85rem; transition: opacity 0.2s;
    }
    .action-btn:hover { opacity: 0.8; }
    .edit-btn { background: #00d203; margin-right: 4px; }
    .delete-btn { background: #e74c3c; }

    /* Modal Base */
    .modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      justify-content: center; align-items: center; padding: var(--gap); z-index: 50;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--bg-light); padding: calc(2*var(--gap));
      border-radius: var(--radius); max-width: 600px; width: 100%;
      max-height: 90%; overflow-y: auto; position: relative;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .modal-content h2 {
      margin-bottom: var(--gap); font-size: 1.25rem;
    }
    .modal-content .close-btn {
      position: absolute; top: var(--gap); right: var(--gap);
      background: none; border: none; font-size: 1.5rem; cursor: pointer;
    }
    .modal-content label {
      display: block; margin-top: var(--gap); font-weight: 500;
    }
    .modal-content input,
    .modal-content select {
      width: 100%; padding: 0.5rem; margin-top: 0.25rem;
      border: 1px solid #ccc; border-radius: var(--radius);
      font-size: 0.95rem;
    }
    .image-list {
      display: flex; gap: 0.5rem; margin-top: var(--gap); overflow-x: auto;
    }
    @media (max-width:768px) {
      header { flex-direction: column; gap: var(--gap); }
      .admin-controls input, .admin-controls select {
        flex: 1 1 100%; margin-bottom: var(--gap);
      }
      table { min-width: unset; }
      .table-wrapper { margin-bottom: var(--gap); }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">VEPA Admin</div>
    <nav>
      <ul>
        <li><a href="index">Home</a></li>
        <li><a href="inventory">Inventory</a></li>
        <li><a href="javascript:doSignOut()">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- ADD NEW CAR + IMPORT CSV -->
    <div class="admin-controls">
      <input id="car-vin" type="text" placeholder="VIN" required>
      <input id="car-make" type="text" placeholder="Make" required>
      <input id="car-model" type="text" placeholder="Model" required>
      <input id="car-price" type="number" placeholder="Price" step="1" required>
      <input id="car-condition" type="text" placeholder="Condition" required>
      <input id="car-mileage" type="number" placeholder="Mileage" required>
      <input id="car-year" type="number" placeholder="Year" required>
      <input id="car-body-type" type="text" placeholder="Body Type" required>
      <select id="car-color">
        <option value="">Color</option>
        <option>Black</option> <option>White</option> <option>Red</option>
        <option>Blue</option> <option>Silver</option> <option>Gray</option>
      </select>
      <select id="car-body-condition">
        <option value="">Body Condition</option>
        <option>Bad</option> <option>Fair</option> <option>Good</option>
      </select>
      <select id="car-interior-condition">
        <option value="">Interior Condition</option>
        <option>Bad</option> <option>Fair</option> <option>Good</option>
      </select>
      <input id="car-transmission" type="text" placeholder="Transmission" required>
      <input id="car-wheels" type="text" placeholder="Wheels" required>
      <input id="car-capacity" type="number" placeholder="Capacity (#)" required>
      <input id="car-features" type="text" placeholder="Features (comma-separated)">
      <button type="button" id="select-drive-images">Select Images from Drive</button>
      <div id="selected-images" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;"></div>

      <input id="car-images" class="hidden-file-input" type="file" multiple accept="image/*">
      <button onclick="document.getElementById('car-images').click()">Upload Images</button>
      <button onclick="addCar()">Add Car</button>

      <!-- CSV/Excel Import Button -->
      <button class="import-btn" onclick="document.getElementById('import-input').click()">
        Import Spreadsheet
      </button>
      <input type="file" id="import-input" accept=".csv,.xlsx" class="hidden-file-input">
      <button onclick="deleteAllCars()" style="background:#e74c3c;color:white;">Delete All Cars</button>
    </div>

    <!-- FILTER / SEARCH -->
    <div class="admin-filter-sort">
      <input id="filter-vin" type="text" placeholder="Filter VIN">
      <input id="filter-make" type="text" placeholder="Filter Make">
      <input id="filter-model" type="text" placeholder="Filter Model">
      <select id="filter-color">
        <option value="">All Colors</option>
        <option>Black</option><option>White</option><option>Red</option><option>Blue</option>
        <option>Silver</option><option>Gray</option>
      </select>
      <select id="filter-body-condition">
        <option value="">All Body Conditions</option>
        <option>Bad</option><option>Fair</option><option>Good</option>
      </select>
      <button onclick="applyFilters()">Apply Filters</button>
      <button onclick="resetFilters()">Reset</button>
    </div>

    <!-- CARS TABLE -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Images</th><th>VIN</th><th>Make</th><th>Model</th><th>Price</th><th>Condition</th><th>Mileage</th><th>Year</th>
            <th>Body Type</th><th>Color</th><th>Body Cond.</th><th>Interior Cond.</th><th>Transmission</th>
            <th>Wheels</th><th>Capacity</th><th>Features</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="cars-table-body"></tbody>
      </table>
    </div>

    <!-- EDIT CAR MODAL -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeEditModal()">×</button>
        <h2>Edit Car</h2>
        <label>VIN <input id="edit-vin" type="text"></label>
        <label>Make <input id="edit-make" type="text"></label>
        <label>Model <input id="edit-model" type="text"></label>
        <label>Price <input id="edit-price" type="number" step="1"></label>
        <label>Condition <input id="edit-condition" type="text"></label>
        <label>Year <input id="edit-year" type="number"></label>
        <label>Mileage <input id="edit-mileage" type="number"></label>
        <label>Body Type <input id="edit-body-type" type="text"></label>
        <label>Color
          <select id="edit-color">
            <option>Black</option><option>White</option><option>Red</option><option>Blue</option>
            <option>Silver</option><option>Gray</option>
          </select>
        </label>
        <label>Body Cond.
          <select id="edit-body-condition">
            <option>Bad</option><option>Fair</option><option>Good</option>
          </select>
        </label>
        <label>Interior Cond.
          <select id="edit-interior-condition">
            <option>Bad</option><option>Fair</option><option>Good</option>
          </select>
        </label>
        <label>Transmission <input id="edit-transmission" type="text"></label>
        <label>Wheels <input id="edit-wheels" type="text"></label>
        <label>Capacity <input id="edit-capacity" type="number"></label>
        <label>Features <input id="edit-features" type="text"></label>
        <label>New Images <input id="edit-images" class="hidden-file-input" type="file" multiple></label>
        <button type="button" id="edit-select-drive-images">Select Images from Drive</button>
        <div id="edit-selected-images" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;"></div>
        <div class="image-list" id="edit-image-list"></div>
        <button onclick="saveEditCar()">Save Changes</button>
      </div>
    </div>

    <!-- VIEW IMAGES MODAL -->
    <div id="view-images-modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeImageModal()">×</button>
        <h2>Car Images</h2>
        <div class="image-list" id="image-list"></div>
        <label>Add Images <input id="new-image-files" class="hidden-file-input" type="file" multiple></label>
        <button onclick="uploadNewImages()">Upload</button>
      </div>
    </div>

  </main>
  <footer>&copy; 2025 VEPA AutoCare</footer>

  <script type="module">
    import {
      initializeApp
    } from 'https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js';
    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      addDoc,
      deleteDoc,
      doc,
      updateDoc
    } from 'https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js';
    import { query, where } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: 'AIzaSyBcKnjZm5LYqj5jx5VEqx9ywspgZyxNfsA',
      authDomain: 'vepa-24b46.firebaseapp.com',
      projectId: 'vepa-24b46',
      storageBucket: 'vepa-24b46.appspot.com',
      messagingSenderId: '170936495301',
      appId: '1:170936495301:web:6f15b8fa08deeb01d5d4ac',
      measurementId: 'G-F8NFZ6SRKR'
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Redirect if not authenticated
    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'login.html';
      else displayCarsAdmin();
    });

    window.doSignOut = async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    };

    // Cloudinary image upload helper
    async function uploadImage(file, folder) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'vepa_unsigned');
      if (folder) formData.append('folder', `cars/${folder}`);

      try {
        const res = await fetch('https://api.cloudinary.com/v1_1/dyjfyxrve/image/upload', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();  // always parse JSON

        if (!res.ok) {
          console.error("Cloudinary error response:", data);
          throw new Error(data.error?.message || "Cloudinary upload failed");
        }

        return data;
      } catch (err) {
        console.error("Upload failed:", err);
        throw err;
      }
    }


  async function handleUploads(files, vin) {
    const arr = [];
    for (const file of Array.from(files)) {
      const data = await uploadImage(file, vin);
      arr.push({ url: data.secure_url, public_id: data.public_id });
    }
    return arr;
  }


    async function fetchCarData() {
      const snap = await getDocs(collection(db, 'cars'));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function displayCarsAdmin(cars) {
      const data = cars || await fetchCarData();
      const body = document.getElementById('cars-table-body');
      body.innerHTML = '';
      data.forEach(car => {
        const tr = document.createElement('tr');
        const thumb = car.images?.[0]?.url || 'GenCar.png';
        tr.innerHTML =
          `<td><img class="thumbnail" src="${thumb}" onclick="openImageModal('${car.id}')"></td>` +
          `<td>${car.vin}</td>` +
          `<td>${car.make}</td><td>${car.model}</td><td>$${Number(car.price).toLocaleString()}</td>` +
          `<td>${car.condition}</td><td>${car.mileage}</td><td>${car.year}</td><td>${car.bodyType}</td><td>${car.color}</td>` +
          `<td>${car.bodyCondition}</td><td>${car.interiorCondition}</td>` +
          `<td>${car.transmission}</td><td>${car.wheels}</td><td>${car.capacity}</td>` +
          `<td>${(car.features||[]).join(', ')}</td>` +
          `<td>` +
            `<button class="action-btn edit-btn" onclick="openEdit('${car.id}')">Edit</button>` +
            `<button class="action-btn delete-btn" onclick="deleteCar('${car.id}')">Delete</button>` +
          `</td>`;
        body.appendChild(tr);
      });
    }

    // removed original addCar (replaced by merged addCar later that supports Drive files)

    async function deleteCar(carId) {
      if (!confirm('Delete this car and all its images?')) return;
      const docRef = doc(db, 'cars', carId);
      const snap = await getDoc(docRef);
      const data = snap.data();
      const public_ids = (data.images||[]).map(i => i.public_id).filter(Boolean);
      if (public_ids.length) {
        await fetch('https://vepa.onrender.com/delete-images', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ public_ids })
        });
      }
      await deleteDoc(docRef);
      alert('Car deleted!');
      displayCarsAdmin();
    }

    async function deleteAllCars() {
  if (!confirm('Are you sure you want to delete ALL cars and their images? This cannot be undone.')) return;

  try {
    // Fetch all cars
    const carsSnap = await getDocs(collection(db, 'cars'));
    const cars = carsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // Delete images from Cloudinary
    const allPublicIds = cars.flatMap(car => (car.images || []).map(img => img.public_id).filter(Boolean));
    if (allPublicIds.length) {
      await fetch('https://vepa.onrender.com/delete-images', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ public_ids: allPublicIds })
      });
    }

    // Delete Firestore documents
    for (const car of cars) {
      await deleteDoc(doc(db, 'cars', car.id));
    }

    alert('All cars and their images have been deleted.');
    displayCarsAdmin();
  } catch (err) {
    console.error('Failed to delete all cars:', err);
    alert('Failed to delete all cars. Check console for details.');
  }
}


    let editId;
    async function openEdit(id) {
      editId = id;
      const car = (await fetchCarData()).find(c => c.id === id);
      if (!car) return;
      document.getElementById('edit-vin').value = car.vin;
      document.getElementById('edit-make').value = car.make;
      document.getElementById('edit-model').value = car.model;
      document.getElementById('edit-price').value = car.price;
      document.getElementById('edit-condition').value = car.condition;
      document.getElementById('edit-year').value = car.year;
      document.getElementById('edit-mileage').value = car.mileage;
      document.getElementById('edit-body-type').value = car.bodyType;
      document.getElementById('edit-color').value = car.color;
      document.getElementById('edit-body-condition').value = car.bodyCondition;
      document.getElementById('edit-interior-condition').value = car.interiorCondition;
      document.getElementById('edit-transmission').value = car.transmission;
      document.getElementById('edit-wheels').value = car.wheels;
      document.getElementById('edit-capacity').value = car.capacity;
      document.getElementById('edit-features').value = (car.features||[]).join(', ');

      // Show existing images
      const list = document.getElementById('edit-image-list');
      list.innerHTML = '';
      (car.images||[]).forEach(img => {
        const elm = document.createElement('img');
        elm.src = img.url;
        elm.style.width = '80px';
        elm.style.height = '60px';
        elm.style.borderRadius = 'var(--radius)';
        elm.style.marginRight = '4px';
        list.appendChild(elm);
      });
      document.getElementById('edit-modal').classList.add('show');
    }

    // async function saveEditCar() {
    //   const updated = {
    //     make: document.getElementById('edit-make').value.trim(),
    //     model: document.getElementById('edit-model').value.trim(),
    //     price: Number(document.getElementById('edit-price').value) || 0,
    //     condition: document.getElementById('edit-condition').value.trim(),
    //     year: Number(document.getElementById('edit-year').value) || 0,
    //     mileage: Number(document.getElementById('edit-mileage').value) || 0,
    //     bodyType: document.getElementById('edit-body-type').value.trim(),
    //     color: document.getElementById('edit-color').value,
    //     bodyCondition: document.getElementById('edit-body-condition').value,
    //     interiorCondition: document.getElementById('edit-interior-condition').value,
    //     transmission: document.getElementById('edit-transmission').value.trim(),
    //     wheels: document.getElementById('edit-wheels').value.trim(),
    //     capacity: Number(document.getElementById('edit-capacity').value) || 0,
    //     features: document.getElementById('edit-features').value
    //       .split(',').map(f=>f.trim()).filter(f=>f)
    //   };
    //   const files = document.getElementById('edit-images').files;
    //   if (files.length) {
    //     try {
    //       const imgs = await handleUploads(files, vin);
    //       const docRef = doc(db, 'cars', editId);
    //       const snap = await getDoc(docRef);
    //       const current = snap.data().images || [];
    //       updated.images = [...current, ...imgs];
    //     } catch (err) {
    //       console.error(err);
    //       alert('Image upload failed during edit.');
    //       return;
    //     }
    //   }
    //   await updateDoc(doc(db, 'cars', editId), updated);
    //   alert('Car updated!');
    //   closeEditModal();
    //   displayCarsAdmin();
    // }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('show');
      // Clear file input
      document.getElementById('edit-images').value = '';
    }

    async function openImageModal(id) {
      const car = (await fetchCarData()).find(c => c.id === id);
      const list = document.getElementById('image-list');
      list.innerHTML = '';
      (car.images||[]).forEach((img, idx) => {
        const wrapper = document.createElement('div');
        wrapper.style.display = 'inline-block';
        wrapper.style.marginRight = '0.5rem';
        const el = document.createElement('img');
        el.src = img.url;
        el.width = 80; el.height = 60;
        el.style.borderRadius = 'var(--radius)';
        wrapper.appendChild(el);

        const btn = document.createElement('button');
        btn.textContent = 'Delete';
        btn.classList.add('action-btn','delete-btn');
        btn.onclick = () => deleteImage(id, idx, img.public_id);
        wrapper.appendChild(btn);

        list.appendChild(wrapper);
      });
      const modal = document.getElementById('view-images-modal');
      modal.dataset.id = id;
      modal.classList.add('show');
    }

    function closeImageModal() {
      document.getElementById('view-images-modal').classList.remove('show');
      document.getElementById('new-image-files').value = '';
    }

    async function uploadNewImages() {
      const modal = document.getElementById('view-images-modal');
      const carId = modal.dataset.id;
      const files = Array.from(document.getElementById('new-image-files').files);
      if (!files.length) {
        alert('Please select images to upload.');
        return;
      }
      try {
        const uploaded = [];
        for (const f of files) {
          const img = await uploadImage(f);
          uploaded.push({ url: img.secure_url, public_id: img.public_id });
        }
        const docRef = doc(db, 'cars', carId);
        const snap = await getDoc(docRef);
        const current = snap.data().images || [];
        await updateDoc(docRef, { images: [...current, ...uploaded] });
        alert('Images uploaded!');
        document.getElementById('new-image-files').value = '';
        openImageModal(carId);
        displayCarsAdmin();
      } catch (err) {
        console.error(err);
        alert('Upload failed.');
      }
    }

    async function deleteImage(carId, idx, public_id) {
      try {
        const docRef = doc(db, 'cars', carId);
        const snap = await getDoc(docRef);
        const data = snap.data();
        const updated = (data.images || []).filter((_, i) => i !== idx);
        await updateDoc(docRef, { images: updated });
        if (public_id) {
          await fetch('https://vepa.onrender.com/delete-images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ public_ids: [public_id] })
          });
        }
        alert('Image deleted!');
        openImageModal(carId);
        displayCarsAdmin();
      } catch (e) {
        console.error(e);
        alert('Failed to delete image.');
      }
    }

    function applyFilters() {
      fetchCarData().then(cars => {
        const fVin = document.getElementById('filter-vin').value;
        const fMake = document.getElementById('filter-make').value.toLowerCase();
        const fModel = document.getElementById('filter-model').value.toLowerCase();
        const fColor = document.getElementById('filter-color').value;
        const fBody = document.getElementById('filter-body-condition').value;
        const filtered = cars.filter(c =>
          (!fMake || c.make.toLowerCase().includes(fMake)) &&
          (!fModel || c.model.toLowerCase().includes(fModel)) &&
          (!fColor || c.color === fColor) &&
          (!fBody || c.bodyCondition === fBody) &&
          (!fVin || c.vin.toLowerCase().includes(fVin.toLowerCase()))
        );
        displayCarsAdmin(filtered);
      });
    }

    function resetFilters() {
      document.querySelectorAll('.admin-filter-sort input, .admin-filter-sort select').forEach(i => i.value = '');
      displayCarsAdmin();
    }
    
    // Handle CSV / XLSX import
    document.getElementById('import-input').addEventListener('change', async e => {
      console.log("Imported: " + e.target.files);
      const file = e.target.files[0];
      if (!file) return;

      // Identify extension
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext === 'csv' || ext === 'txt') {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: async results => {
            const rows = results.data; // Array of objects
            await processSpreadsheetRows(rows);
            alert('Spreadsheet imported successfully!');
            displayCarsAdmin();
            e.target.value = '';
          },
          error: err => {
            console.error(err);
            alert('Error parsing CSV.');
          }
        });
      } else if (ext === 'xlsx' || ext === 'xls') {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(firstSheet, { raw: false });
        await processSpreadsheetRows(rows);
        alert('Spreadsheet imported successfully!');
        displayCarsAdmin();
        e.target.value = '';
      } else {
        alert('Unsupported file format. Please upload CSV or XLSX.');
        e.target.value = '';
      }
    });
    
    // Attempt to match common field names to Firestore schema

function parseNumber(val) {
  if (!val) return 0;
  const num = parseFloat(String(val).replace(/[^0-9.-]+/g, '').trim());
  return isNaN(num) ? 0 : num;
}

function normalizeCar(car) {
  return {
    make: String(car.make || '').trim().toLowerCase(),
    model: String(car.model || '').trim().toLowerCase(),
    price: Number(car.price) || 0,
    condition: String(car.condition || '').trim().toLowerCase(),
    year: Number(car.year) || 0,
    mileage: Number(car.mileage) || 0,
    bodyType: String(car.bodyType || '').trim().toLowerCase(),
    color: String(car.color || '').trim().toLowerCase(),
    bodyCondition: String(car.bodyCondition || '').trim().toLowerCase(),
    interiorCondition: String(car.interiorCondition || '').trim().toLowerCase(),
    transmission: String(car.transmission || '').trim().toLowerCase(),
    wheels: String(car.wheels || '').trim().toLowerCase(),
    capacity: Number(car.capacity) || 0,
    features: (car.features || []).map(f => f.trim().toLowerCase()).sort()
  };
}

function isSameCar(carA, carB) {
  const a = normalizeCar(carA);
  const b = normalizeCar(carB);
  return a.make === b.make &&
         a.model === b.model &&
         a.price === b.price &&
         a.condition === b.condition &&
         a.year === b.year &&
         a.mileage === b.mileage &&
         a.bodyType === b.bodyType &&
         a.color === b.color &&
         a.bodyCondition === b.bodyCondition &&
         a.interiorCondition === b.interiorCondition &&
         a.transmission === b.transmission &&
         a.wheels === b.wheels &&
         a.capacity === b.capacity &&
         a.features.join(',') === b.features.join(',');
}

async function processSpreadsheetRows(rows) {
  for (const row of rows) {
    // Normalize row keys
    const normalized = {};
    Object.keys(row).forEach(key => {
      normalized[key.trim().toLowerCase()] = row[key];
    });

    console.log(Object.keys(rows[0]) + " rows");
    // Read values with fallback options
    const vin = normalized.vin || '';
    const make = normalized.make || '';
    const model = normalized.model || '';
    const condition = normalized.condition || '';
    const year = parseNumber(normalized['model year']);
    const price = parseNumber(normalized['sales price']);
    const bodyType = normalized['body type'] || '';
    const color = normalized.color || '';
    const capacity = parseNumber(normalized['# of passengers']);
    const mileage = parseNumber(normalized['odometer reading at the time of purchase']);
    const features = (normalized.features || '').split(',').map(f => f.trim()).filter(f => f);


    const bodyCondition = normalized['body condition'] || '';
    const interiorCondition = normalized['interior condition'] || '';
    const transmission = normalized.transmission || '';
    const wheels = normalized.wheels || '';

    if (!vin || !make || !model) continue;

    const carObj = {
      vin, make, model, price, condition, year, mileage, bodyType,
      color, bodyCondition, interiorCondition, transmission,
      wheels, capacity, features, images: []
    };

    try {
      const carsRef = collection(db, 'cars');
      const q = query(carsRef, where("vin", "==", vin));
      const snap = await getDocs(q);

      if (!snap.empty) {
        const existing = snap.docs[0];
        const existingData = existing.data();

        if (isSameCar(carObj, existingData)) {
          console.log(`Skipped VIN ${vin} — identical data`);
          continue;
        }

        const override = confirm(`A car with VIN ${vin} exists. Override with new data?`);
        if (override) {
          await updateDoc(doc(db, "cars", existing.id), carObj);
          console.log(`Updated car VIN ${vin}`);
        } else {
          console.log(`Skipped VIN ${vin} — user chose not to override`);
        }
      } else {
        await addDoc(carsRef, carObj);
        console.log(`Added new car VIN ${vin}`);
      }
    } catch (err) {
      console.error('Error processing row:', carObj, err);
    }
  }

  alert('Spreadsheet import completed!');
}


    // EXPOSE GLOBALS
    window.deleteCar = deleteCar;
    window.deleteAllCars = deleteAllCars;
    window.openEdit = openEdit;
    window.saveEditCar = saveEditCar;
    window.closeEditModal = closeEditModal;
    window.openImageModal = openImageModal;
    window.closeImageModal = closeImageModal;
    window.uploadNewImages = uploadNewImages;
    window.deleteImage = deleteImage;
    window.applyFilters = applyFilters;
    window.resetFilters = resetFilters;

    // =========================
    // Google Drive Picker Setup
    // Replace with your Google credentials
    const GOOGLE_API_KEY = 'AIzaSyD-Fh5YgEBpn13MB6h32JxmkKnRwMqaT2U';
    const GOOGLE_CLIENT_ID = '57484859036-orsqvos98jjmmgd6uqpiluei7mf9qruk.apps.googleusercontent.com';
    const GOOGLE_APP_ID = '57484859036';
    const GOOGLE_SCOPES = ['https://www.googleapis.com/auth/drive.readonly'];

    // Holds File objects created from Drive for add/edit flows
    let selectedDriveFilesAdd = [];
    let selectedDriveFilesEdit = [];

    // Helper: wait until gapi & google.picker are available
    function waitForPickerLib(timeout = 10000) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function check() {
          if (window.gapi && window.google && window.google.picker) return resolve();
          if (Date.now() - start > timeout) return reject(new Error('Google Picker libs not loaded'));
          setTimeout(check, 100);
        })();
      });
    }

    async function openDrivePicker(forEdit = false) {
      await waitForPickerLib();

      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: GOOGLE_SCOPES.join(' '),
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            createPicker(tokenResponse.access_token, forEdit);
          } else {
            alert('Google authorization failed.');
          }
        }
      });

      tokenClient.requestAccessToken({ prompt: 'consent' });
    }


    function createPicker(oauthToken, forEdit) {
      const view = new google.picker.View(google.picker.ViewId.DOCS_IMAGES);
      view.setMimeTypes('image/png,image/jpeg,image/jpg,image/gif');
      const picker = new google.picker.PickerBuilder()
        .addView(view)
        .setAppId(GOOGLE_APP_ID)
        .setDeveloperKey(GOOGLE_API_KEY)
        .setOAuthToken(oauthToken)
        .setCallback(data => pickerCallback(data, forEdit, oauthToken))
        .build();
      picker.setVisible(true);
    }

    async function pickerCallback(data, forEdit, oauthToken) {
      if (data.action === google.picker.Action.PICKED) {
        const docs = data.docs || [];
        for (const d of docs) {
          try {
            // fetch file content as blob using Drive v3 ?alt=media endpoint
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${d.id}?alt=media`, {
              headers: { Authorization: 'Bearer ' + oauthToken }
            });
            if (!res.ok) {
              console.error('Drive file fetch failed', await res.text());
              continue;
            }
            const blob = await res.blob();
            const file = new File([blob], d.name, { type: d.mimeType || blob.type });
            if (forEdit) {
              selectedDriveFilesEdit.push(file);
              renderSelectedDrivePreview(file, 'edit-selected-images');
            } else {
              selectedDriveFilesAdd.push(file);
              renderSelectedDrivePreview(file, 'selected-images');
            }
          } catch (err) {
            console.error('Failed to fetch Drive file', err);
          }
        }
      }
    }

    function renderSelectedDrivePreview(file, containerId) {
      const container = document.getElementById(containerId);
      const url = URL.createObjectURL(file);
      const wrapper = document.createElement('div');
      wrapper.style.display = 'inline-block';
      wrapper.style.position = 'relative';
      wrapper.style.marginRight = '8px';
      const img = document.createElement('img');
      img.src = url;
      img.style.width = '80px';
      img.style.height = '60px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '6px';
      wrapper.appendChild(img);
      const btn = document.createElement('button');
      btn.textContent = 'Remove';
      btn.style.display = 'block';
      btn.style.marginTop = '4px';
      btn.onclick = () => {
        // remove from array
        if (containerId === 'selected-images') {
          selectedDriveFilesAdd = selectedDriveFilesAdd.filter(f => f !== file);
        } else {
          selectedDriveFilesEdit = selectedDriveFilesEdit.filter(f => f !== file);
        }
        wrapper.remove();
        URL.revokeObjectURL(url);
      };
      wrapper.appendChild(btn);
      container.appendChild(wrapper);
    }

    // Wire up buttons
    document.getElementById('select-drive-images').addEventListener('click', () => openDrivePicker(false));
    document.getElementById('edit-select-drive-images').addEventListener('click', () => openDrivePicker(true));

    // Combine Drive-selected files with normal file inputs when adding/editing
    const _addCar_original = addCar;
    async function addCar() {
      // gather file inputs + drive files
      const inputFiles = Array.from(document.getElementById('car-images').files || []);
      const driveFiles = selectedDriveFilesAdd || [];
      const allFiles = [...inputFiles, ...driveFiles];

      // reuse existing addCar logic but with allFiles
      // Validate & gather fields (duplicate of original beginning to keep flow)
      const vin = document.getElementById('car-vin').value.trim();
      if (!vin) { alert("VIN is required."); return; }
      const make = document.getElementById('car-make').value.trim();
      const model = document.getElementById('car-model').value.trim();
      if (!make || !model) { alert('Please fill in required fields.'); return; }
      const price = Number(document.getElementById('car-price').value) || 0;
      const condition = document.getElementById('car-condition').value.trim();
      const year = Number(document.getElementById('car-year').value) || 0;
      const mileage = Number(document.getElementById('car-mileage').value) || 0;
      const bodyType = document.getElementById('car-body-type').value.trim();
      const color = document.getElementById('car-color').value;
      const bodyCondition = document.getElementById('car-body-condition').value;
      const interiorCondition = document.getElementById('car-interior-condition').value;
      const transmission = document.getElementById('car-transmission').value.trim();
      const wheels = document.getElementById('car-wheels').value.trim();
      const capacity = Number(document.getElementById('car-capacity').value) || 0;
      const features = document.getElementById('car-features').value
        .split(',').map(f => f.trim()).filter(f => f);

      let images = [];
      if (allFiles.length) {
        try {
          images = await handleUploads(allFiles, vin);
        } catch (err) {
          console.error(err);
          alert('Image upload failed.');
          return;
        }
      }

      // rest of original addCar flow (create carObj, check duplicate VIN, add/update doc)
      const carObj = {
        vin,
        make,
        model,
        price,
        condition,
        year,
        mileage,
        bodyType,
        color,
        bodyCondition,
        interiorCondition,
        transmission,
        wheels,
        capacity,
        features,
        images
      };

      const carsRef = collection(db, 'cars');
      const q = query(carsRef, where("vin", "==", vin));
      const snap = await getDocs(q);

      if (!snap.empty) {
        if (confirm("A car with this VIN already exists. Do you want to override it?")) {
          const existing = snap.docs[0];
          await updateDoc(doc(db, "cars", existing.id), carObj);
          alert("Car updated successfully!");
          displayCarsAdmin();
        } else {
          alert("Car not added — duplicate VIN.");
        }
        return;
      }

      await addDoc(carsRef, carObj);
      alert("Car added successfully!");
      displayCarsAdmin();

      // Clear fields and selected Drive files
      [
        'car-vin','car-make','car-model','car-price','car-condition','car-year','car-mileage','car-body-type',
        'car-color','car-body-condition','car-interior-condition','car-transmission',
        'car-wheels','car-capacity','car-features','car-images'
      ].forEach(id => {
        const el = document.getElementById(id);
        if (el && el.type === 'file') el.value = '';
        else if (el) el.value = '';
      });
      selectedDriveFilesAdd = [];
      const selAddContainer = document.getElementById('selected-images');
      if (selAddContainer) selAddContainer.innerHTML = '';
    }

    // Modified saveEditCar to include Drive selected files
    const _saveEditCar_original = saveEditCar;
    async function saveEditCar() {
      const updated = {
        make: document.getElementById('edit-make').value.trim(),
        model: document.getElementById('edit-model').value.trim(),
        price: Number(document.getElementById('edit-price').value) || 0,
        condition: document.getElementById('edit-condition').value.trim(),
        year: Number(document.getElementById('edit-year').value) || 0,
        mileage: Number(document.getElementById('edit-mileage').value) || 0,
        bodyType: document.getElementById('edit-body-type').value.trim(),
        color: document.getElementById('edit-color').value,
        bodyCondition: document.getElementById('edit-body-condition').value,
        interiorCondition: document.getElementById('edit-interior-condition').value,
        transmission: document.getElementById('edit-transmission').value.trim(),
        wheels: document.getElementById('edit-wheels').value.trim(),
        capacity: Number(document.getElementById('edit-capacity').value) || 0,
        features: document.getElementById('edit-features').value
          .split(',').map(f=>f.trim()).filter(f=>f)
      };

      const inputFiles = Array.from(document.getElementById('edit-images').files || []);
      const driveFiles = selectedDriveFilesEdit || [];
      const allFiles = [...inputFiles, ...driveFiles];

      if (allFiles.length) {
        try {
          // use VIN if present, else editId as folder
          const vin = (document.getElementById('edit-vin').value || editId).trim();
          const imgs = await handleUploads(allFiles, vin);
          const docRef = doc(db, 'cars', editId);
          const snap = await getDoc(docRef);
          const current = snap.data().images || [];
          updated.images = [...current, ...imgs];
        } catch (err) {
          console.error(err);
          alert('Image upload failed during edit.');
          return;
        }
      }
      await updateDoc(doc(db, 'cars', editId), updated);
      alert('Car updated!');
      closeEditModal();
      displayCarsAdmin();
      // clear edit drive selections
      selectedDriveFilesEdit = [];
      const selEditContainer = document.getElementById('edit-selected-images');
      if (selEditContainer) selEditContainer.innerHTML = '';
    }

    // expose modified functions
    window.addCar = addCar;
    window.saveEditCar = saveEditCar;
    // =========================
  </script>

  <!-- PapaParse (CSV) & SheetJS (XLSX) libraries (integrity attributes removed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
  <script type="text/javascript" src="https://apis.google.com/js/client:picker.js"></script>

</body>
</html>
